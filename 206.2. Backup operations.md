
---

### **206.2 Backup operations**

**Weight:** 3

**Description:** Candidates should be able to use system tools to back up important system data.

**Key Knowledge Areas:**

* Knowledge about directories that have to be include in backups
* Awareness of network backup solutions such as Amanda, Bacula, Bareos and BackupPC
* Knowledge of the benefits and drawbacks of tapes, CDR, disk or other backup media
* Perform partial and manual backups.
* Verify the integrity of backup files.
* Partially or fully restore backups.

**Terms and Utilities:**

* /bin/sh
* dd
* tar
* /dev/st\* and /dev/nst\*
* mt
* rsync

### Why do we need to Backup?

We have already talk about RAID and LVM, although making RAID group or creating LVM, make sort of reliability and safetiness but they are not consider as backup solutions. We might lose data and experience failure because of different reasons:

* electricity goes off
* Hardware failure \(mobo, cpu, ram, hard disks, ...\)
* human kind miss configuration
* ...

To tell the truth the last reason is the most common and the most dangerous one. To avoid them we need to backup, we have to backup, we are forced to backup.

### What to backup?

Not all directories and file are required to be backed up especially when there backup space issues. In linux File System Hierarchy Standard \(FHS\) there are directories and files with different priority for backing up:

| Directory | Priority | Description |
| :--- | :--- | :--- |
| /etc/ | high | system wide configuration files required for all programs |
| /home/ | high | Home directories for all users to store their personal files |
| /usr/local/ | high | contains users programs that you install from source |
| /var/lib/ | medium | contains lots of data, getting full backup leave us on the safe side. |
| /var/mail/ | medium | local emails |
| /var/www/ | medium | deafult web root |
| /var/spool/ | medium | printer queues but might used by some applications |
| /var/log/ | low | system log files |
| /opt/ | medium | Contains add-on applications from individual vendors |
| /usr/ | low | Contains binaries, libraries, documentation, and source-code for second level program |

### How to backup?

In any platform there are always some native tools and third party programs for backing up:

| Package | Licence | Language | Graphical user \(GUI\) interface | Command Line\(CMD\)interface |
| :--- | :--- | :--- | :--- | :--- |
| ![](/assets/logo_amanda.png) | BSD | C , Perl | No \(except with Amanda Enterprise\) | Yes |
| ![](/assets/logo-backuppc.gif) | GPLv2.0 | Perl | Yes | Yes |
| ![](/assets/logo-bacula.png) | AGPLv3.0 | C , C++ | Yes | Yes |

All three Packages has Linux, windows, MacOS versions. Now lets spend time on some traditional native tools for backing up.

#### tape

Using tapes for backing up is some how out modded but tapes are still used because they are cheap and huge but they are very slow. If we have had  chance to administrate a system with tape device plugged, we would see these directories.

* /dev/st0
* /dev/nst0

The /dev/nst0 device is a non rewinding tape device, where as the /dev/st0 device is a rewinding tape device. The device you choose to use depends on your goal. Both devices are for the same piece of hardware but they behave differently. we can rewind  /dev/st0 by using   software but we can not use software for /dev/nst0 so we have to rewind it physically.

#### Understanding tape file marks and block size

![](/assets/tape-tapefilemark.jpg)

Each tape device can store multiple tape backup files. Tape backup files are created using cpio, tar, dd, and so on. However, tape device can be opened, written data to, and closed by the various program. We can store several backups \(tapes\) on physical tape. Between each tape file is a “tape file mark”. This is used to indicate where one tape file ends and another begins on physical tape. You need to use mt command to positions the tape \(winds forward and rewinds and marks\)[^1].

#### mt command

mt command is used to control operations of the tape drive, such as finding status or seeking through files on a tape or writing tape control marks to the tape.

| some mt command examples | Description |
| :--- | :--- |
| mt -f /dev/st0 rewind | rewind tape drive |
| mt -f /dev/st0 status | Display status  information about tape unit |
| mt -f /dev/st0 erase | erase the tape |
| mt -f /dev/st0 eject | eject tape drive |
| mt -f /dev/st0 eof | Writes n EOF marks in the current position of tape |

Here is the list of tape position commands:

```
       fsf    Forward space count files.  The tape is positioned on the first block of the next file.

       fsfm   Forward space count files.  The tape is positioned on the last block of the previous file.

       bsf    Backward space count files.  The tape is positioned on the last block of the previous file.

       bsfm   Backward space count files.  The tape is positioned on the first block of the next file.

       asf    The tape is positioned at the beginning of the count file.
              Positioning is done by first rewinding the tape and then spacing forward over count filemarks.

       fsr    Forward space count records.

       bsr    Backward space count records.

       fss    (SCSI tapes) Forward space count setmarks.

       bss    (SCSI tapes) Backward space count setmarks.
```

and many many other options.

#### How is data stored on a tape drive ?

![](/assets/tape-hawstored.jpg)

All data is stored subsequently in sequential tape archive format using tar. The first tape archive will start on the physical beginning of the tape \(tar \#0\). The next will be tar \#1 and so on.

### tar

We have got to use tar \(tape archive\(r\)\) to create tar files, but infact its designed to archive files on tape device.

```
root@server1:~# tree mydirectory/
mydirectory/
├── dir1
│   └── file1.txt
├── dir2
│   └── file2.txt
├── dir3
│   └── file3.txt
└── myfile

3 directories, 4 files
root@server1:~# tar -cvf backup-mydirectory.tar mydirectory/
mydirectory/
mydirectory/dir3/
mydirectory/dir3/file3.txt
mydirectory/myfile
mydirectory/dir1/
mydirectory/dir1/file1.txt
mydirectory/dir2/
mydirectory/dir2/file2.txt

root@server1:~# ls
backup-mydirectory.tar  mydirectory  pooler-cpuminer-2.5.0.tar.gz
cpuminer                mynfs
```

Opps, delete some file inorder to restore it from our backup:

```
root@server1:~# rm -rf mydirectory/myfile , mydirectory/dir3
root@server1:~# tree mydirectory/
mydirectory/
├── dir1
│   └── file1.txt
└── dir2
    └── file2.txt

2 directories, 2 files
root@server1:~# ls
backup-mydirectory.tar  mydirectory  pooler-cpuminer-2.5.0.tar.gz
cpuminer                mynfs
```

List the files inside tar file with -tvf switches:

```
root@server1:~# tar -tvf backup-mydirectory.tar 
drwxr-xr-x root/root         0 2018-02-05 03:54 mydirectory/
drwxr-xr-x root/root         0 2018-02-05 03:54 mydirectory/dir3/
-rw-r--r-- root/root         0 2018-02-05 03:54 mydirectory/dir3/file3.txt
-rw-r--r-- root/root         0 2018-02-05 03:53 mydirectory/myfile
drwxr-xr-x root/root         0 2018-02-05 03:54 mydirectory/dir1/
-rw-r--r-- root/root         0 2018-02-05 03:54 mydirectory/dir1/file1.txt
drwxr-xr-x root/root         0 2018-02-05 03:54 mydirectory/dir2/
-rw-r--r-- root/root         0 2018-02-05 03:54 mydirectory/dir2/file2.txt
```

We need to restore myfile and dir3 from our backup:

```
root@server1:~# tar -xvf backup-mydirectory.tar  mydirectory/myfile
mydirectory/myfile
root@server1:~# tree mydirectory/
mydirectory/
├── dir1
│   └── file1.txt
├── dir2
│   └── file2.txt
└── myfile

2 directories, 3 files
root@server1:~# tar -xvf backup-mydirectory.tar  mydirectory/dir3/file3.txt 
mydirectory/dir3/file3.txt
root@server1:~# tree mydirectory/
mydirectory/
├── dir1
│   └── file1.txt
├── dir2
│   └── file2.txt
├── dir3
│   └── file3.txt
└── myfile

3 directories, 4 files
```

Lets combine usefull tar switches as a quick review:

| tar command | Description |
| :--- | :--- |
| tar -cvf mybackup.tar myfiles/ | Create tar backup file |
| tar -cvzf mybackup.tar.gz myfiles/ | Create tar.gzip backup file |
| tar -cvjf mybackup.tar.bz2 myfiles/ | Create tar.bzip2 backup file |
| tar -xvf mybackup.tar | Uncompress tar or gzip or bzip2 files |
| tar -tvf mybackup.tar | List content of tar or gzip or bzip2  files |
| tar -xvf mybackup.tar myfile | Extract a single file from tar, tar.gz and tar.bz2 file |
| tar -xvf mybackup.tar "file1.txt" "file2.txt" |  Untar Multiple files from tar, tar.gz and tar.bz2 file |
| tar -xvf mybackup.tar --wildcards '\*.conf' | Extract group of files using wildcard |
| tar -rvf mybackup.tar xyz.txt | Add files or directories to a tar, tar.gz and tar.bz2 file |
| tar -xvfW mybackup.tar  | Verify tar, tar.gz and tar.bz2 Archive File |
| tar -czf mybackup.tar | Check the Size of the tar, tar.gz and tar.bz2 Archive File |

### rsync



