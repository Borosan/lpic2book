**203.2 Maintaining a Linux filesystem​**

**Weight:**3

**Description:** Candidates should be able to properly maintain a Linux filesystem using system utilities. This objective includes manipulating standard filesystems and monitoring SMART devices.

**Key Knowledge Areas:**

* Tools and utilities to manipulate and ext2, ext3 and ext4
* Tools and utilities to perform basic Btrfs operations, including subvolumes and snapshots
* Tools and utilities to manipulate XFS
* Awareness of ZFS

**Terms and Utilities:**

* mkfs \(mkfs.\*\)
* mkswap
* fsck \(fsck.\*\)
* tune2fs, dumpe2fs and debugfs
* btrfs, btrfs-convert
* xfs\_info, xfs\_check, xfs\_repair, xfsdump and xfsrestore
* smartd, smartctl

### File Systems Overview

Since lpic 1 course we have got familiar with some File Systems. Lets Compare important ones:

| File System | Architecture | Max File Size | Max Volume Size | extends | journal | snapshot |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| ext2 \(1993\) | h-tree | 2 Tbytes | 32 Tbytes | No | No | No |
| ext3 \(2001\) | h-tree | 2 Tbytes | 32 Tbytes | No | Yes | No |
| ext4 \(2006\) | h-tree | 16 Tbytes | 1 Ebytes | Yes | Yes | No |
| xfs \(1994\) | b-tree | 8 Ebytes | 8 Ebytes | No | Yes | Planned |
| btrfs \(2009\) | b-tree | 16 Ebytes | 16 Ebytes | Yes | Yes | Yes |

### mkfs

mkfs \(Make a file System\) command is used to create a File System on  a device.To review LPIC1:

```
root@server1:~# lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sdb      8:16   0   10G  0 disk 
└─sdb1   8:17   0   10G  0 part 
sr0     11:0    1 1024M  0 rom  
sda      8:0    0   50G  0 disk 
├─sda2   8:2    0    1K  0 part 
├─sda5   8:5    0 1021M  0 part [SWAP]
└─sda1   8:1    0   49G  0 part /

root@server1:~# which mkfs
/sbin/mkfs
```

We saw that mkfs is a front end for other commands:

```
root@server1:~# ls /sbin | grep mkfs
mkfs
mkfs.bfs
mkfs.cramfs
mkfs.ext2
mkfs.ext3
mkfs.ext4
mkfs.ext4dev
mkfs.fat
mkfs.minix
mkfs.msdos
mkfs.ntfs
mkfs.vfat
```

We can use  mkfs.ext4 /dev/sdb1 to format a partition or in another format:

```
root@server1:~# mkfs -t ext4 /dev/sdb1
mke2fs 1.42.13 (17-May-2015)
Creating filesystem with 2621184 4k blocks and 655360 inodes
Filesystem UUID: 3f940f9b-d46d-423e-9f20-4cf74564e7ac
Superblock backups stored on blocks: 
    32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632

Allocating group tables: done                            
Writing inode tables: done                            
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done
```

### mkswap

There is an exception among File Systems which is swap. We have mentioned that swap can be a file or an entire partition. To make a swap partition use mkswap /dev/sdXY command

### File System maintenance Tools

Each file system has it own tools to maintain the problems.

#### fsck

fsck \( File System consistency check\) is a tool for checking and repairing linux  file system. Like mkfs, fsck is a front of other commands. fsck is originally an ext tool . Try not to use fsck for other file systems because it might cause damage or data lost! How ever it is smart about other file systems like XFS and avoid running on them.

```
root@server1:~# mount /dev/sdb1 /mnt/my10gdisk/
root@server1:~# lsblk
NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sdb      8:16   0   10G  0 disk 
└─sdb1   8:17   0   10G  0 part /mnt/my10gdisk
sr0     11:0    1 1024M  0 rom  
sda      8:0    0   50G  0 disk 
├─sda2   8:2    0    1K  0 part 
├─sda5   8:5    0 1021M  0 part [SWAP]
└─sda1   8:1    0   49G  0 part /
root@server1:~# fsck /dev/sdb1
fsck from util-linux 2.27.1
e2fsck 1.42.13 (17-May-2015)
/dev/sdb1 is mounted.
e2fsck: Cannot continue, aborting.
```

Do not forget you can not check a filesystem while you are using that, so do not forget to unmount!!!

```
root@server1:~# umount /mnt/my10gdisk 
root@server1:~# fsck /dev/sdb1
fsck from util-linux 2.27.1
e2fsck 1.42.13 (17-May-2015)
/dev/sdb1: clean, 11/655360 files, 79663/2621184 blocks
```

#### fsck exit codes:

```
0-No errors
1-Filesystem errors corrected
2-System should be rebooted
4-Filesystem errors left uncorrected
8-Operational error
16-Usage or syntax error
32-Checking canceled by user request
128-Shared-library error
```

| fsck usefull switeches | Description |
| :--- | :--- |
| -f | force fixing errors, ask conformation before each repair |
| -y | say "yes" to confirm fixing all errors |
| -n | emulate fixing errors, but no real write on hard disk |
| -N | Tell what command will be used, and nothing run |

tune2fs Change different aspects of file system

dumpe2fs Show all super blocks info

debugfs interactive file system editor

```
root@server1:~# dumpe2fs /dev/sdb1
dumpe2fs 1.42.13 (17-May-2015)
Filesystem volume name:   <none>
Last mounted on:          <not available>
Filesystem UUID:          395e0905-bcc7-4b8d-b3ca-3193c266b749
Filesystem magic number:  0xEF53
Filesystem revision #:    1 (dynamic)
Filesystem features:      has_journal ext_attr resize_inode dir_index filetype extent flex_bg sparse_super large_file huge_file uninit_bg dir_nlink extra_isize
Filesystem flags:         signed_directory_hash 
Default mount options:    user_xattr acl
Filesystem state:         clean
Errors behavior:          Continue
Filesystem OS type:       Linux
Inode count:              655360
Block count:              2621184
Reserved block count:     131059
Free blocks:              2541521
Free inodes:              655349
First block:              0
Block size:               4096
Fragment size:            4096
Reserved GDT blocks:      639
Blocks per group:         32768
Fragments per group:      32768
Inodes per group:         8192
Inode blocks per group:   512
Flex block group size:    16
Filesystem created:       Sat Dec 30 04:03:38 2017
Last mount time:          Sat Dec 30 04:03:54 2017
Last write time:          Sat Dec 30 04:05:42 2017
Mount count:              1
Maximum mount count:      -1
Last checked:             Sat Dec 30 04:03:38 2017
Check interval:           0 (<none>)
Lifetime writes:          291 MB
Reserved blocks uid:      0 (user root)
Reserved blocks gid:      0 (group root)
First inode:              11
Inode size:              256
Required extra isize:     28
Desired extra isize:      28
Journal inode:            8
Default directory hash:   half_md4
Directory Hash Seed:      54a34eb1-0de8-40af-8e37-e4817b1f3046
Journal backup:           inode blocks
Journal features:         (none)
Journal size:             128M
Journal length:           32768
Journal sequence:         0x00000004
Journal start:            0


Group 0: (Blocks 0-32767) [ITABLE_ZEROED]
  Checksum 0xe944, unused inodes 8181
  Primary superblock at 0, Group descriptors at 1-1
  Reserved GDT blocks at 2-640
  Block bitmap at 641 (+641), Inode bitmap at 657 (+657)
  Inode table at 673-1184 (+673)
  23897 free blocks, 8181 free inodes, 2 directories, 8181 unused inodes
  Free blocks: 8871-32767
  Free inodes: 12-8192
Group 1: (Blocks 32768-65535) [INODE_UNINIT, BLOCK_UNINIT, ITABLE_ZEROED]
  Checksum 0xda21, unused inodes 8192
  Backup superblock at 32768, Group descriptors at 32769-32769
  Reserved GDT blocks at 32770-33408
  Block bitmap at 642 (bg #0 + 642), Inode bitmap at 658 (bg #0 + 658)
  Inode table at 1185-1696 (bg #0 + 1185)
  32127 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes
  Free blocks: 33409-65535
  Free inodes: 8193-16384
Group 2: (Blocks 65536-98303) [INODE_UNINIT, BLOCK_UNINIT, ITABLE_ZEROED]
  Checksum 0x8c02, unused inodes 8192
  Block bitmap at 643 (bg #0 + 643), Inode bitmap at 659 (bg #0 + 659)
  Inode table at 1697-2208 (bg #0 + 1697)
  32768 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes
  Free blocks: 65536-98303
  Free inodes: 16385-24576
.
..
...

Group 78: (Blocks 2555904-2588671) [INODE_UNINIT, BLOCK_UNINIT, ITABLE_ZEROED]
  Checksum 0x2104, unused inodes 8192
  Block bitmap at 2097166 (bg #64 + 14), Inode bitmap at 2097182 (bg #64 + 30)
  Inode table at 2104352-2104863 (bg #64 + 7200)
  32768 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes
  Free blocks: 2555904-2588671
  Free inodes: 638977-647168
Group 79: (Blocks 2588672-2621183) [INODE_UNINIT, ITABLE_ZEROED]
  Checksum 0x8657, unused inodes 8192
  Block bitmap at 2097167 (bg #64 + 15), Inode bitmap at 2097183 (bg #64 + 31)
  Inode table at 2104864-2105375 (bg #64 + 7712)
  32512 free blocks, 8192 free inodes, 0 directories, 8192 unused inodes
  Free blocks: 2588672-2621183
  Free inodes: 647169-655360
```

```
root@server1:~# tune2fs --help
tune2fs 1.42.13 (17-May-2015)
tune2fs: invalid option -- '-'
Usage: tune2fs [-c max_mounts_count] [-e errors_behavior] [-g group]
    [-i interval[d|m|w]] [-j] [-J journal_options] [-l]
    [-m reserved_blocks_percent] [-o [^]mount_options[,...]] [-p mmp_update_interval]
    [-r reserved_blocks_count] [-u user] [-C mount_count] [-L volume_label]
    [-M last_mounted_dir] [-O [^]feature[,...]]
    [-Q quota_options]
    [-E extended-option[,...]] [-T last_check_time] [-U UUID]
    [ -I new_inode_size ] device
```

#### maintenance XFS File System

XFS File System has its own tools.Base on our distro we might need to install xfsprogs to use XFS tools.

```

[root@server1 ~]# lsblk
NAME            MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda               8:0    0   50G  0 disk 
├─sda1            8:1    0    1G  0 part /boot
└─sda2            8:2    0   49G  0 part 
  ├─centos-root 253:0    0 45.1G  0 lvm  /
  └─centos-swap 253:1    0  3.9G  0 lvm  [SWAP]
sdb               8:16   0   10G  0 disk 
└─sdb1            8:17   0   10G  0 part 
sr0              11:0    1 1024M  0 rom  
[root@server1 ~]# mkfs.xfs /dev/sdb1
meta-data=/dev/sdb1              isize=512    agcount=4, agsize=655296 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0, sparse=0
data     =                       bsize=4096   blocks=2621184, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
```

Okey we have Formatted and re partitioned /dev/sdb1 let play with some XFS File System tools:

| xfsprogs | Description |
| :--- | :--- |
| xfs\_info | Give info about XFS Partition, partition must be mounted |
| xfs\_repair | Fix XFS File System problem |
| xfs\_check  | Depricated ! Check XFS File System problems with no verbosity, use -v or "xfs\_repair -n" instead |

#### xfs\_info

```
[root@server1 ~]# mkdir /mnt/my10gxfs
[root@server1 ~]# mount /dev/sdb1 /mnt/my10gxfs/
[root@server1 ~]# xfs_info /mnt/my10gxfs/
meta-data=/dev/sdb1              isize=512    agcount=4, agsize=655296 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0 spinodes=0
data     =                       bsize=4096   blocks=2621184, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
```

#### xfs\_repair

```
[root@server1 ~]# umount /mnt/my10gxfs/

[root@server1 ~]# xfs_repair -n /dev/sdb1
Phase 1 - find and verify superblock...
Phase 2 - using internal log
        - zero log...
        - scan filesystem freespace and inode maps...
        - found root inode chunk
Phase 3 - for each AG...
        - scan (but don't clear) agi unlinked lists...
        - process known inodes and perform inode discovery...
        - agno = 0
        - agno = 1
        - agno = 2
        - agno = 3
        - process newly discovered inodes...
Phase 4 - check for duplicate blocks...
        - setting up duplicate extent list...
        - check for inodes claiming duplicate blocks...
        - agno = 0
        - agno = 2
        - agno = 3
        - agno = 1
No modify flag set, skipping phase 5
Phase 6 - check inode connectivity...
        - traversing filesystem ...
        - traversal finished ...
        - moving disconnected inodes to lost+found ...
Phase 7 - verify link counts...
No modify flag set, skipping filesystem flush and exiting.
```

and if any problems have found use xfs\_repair for that.



