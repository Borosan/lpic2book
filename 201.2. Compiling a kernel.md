### **201.2 Compiling a kernel**

### **Weight: **3

**Description: **Candidates should be able to properly configure a kernel to include or disable specific features of the Linux kernel as necessary. This objective includes compiling and recompiling the Linux kernel as needed, updating and noting changes in a new kernel, creating an initrd image and installing new kernels.

**Key Knowledge Areas:**

* /usr/src/linux/
* Kernel Makefiles
* Kernel 2.6.x/3.x make targets
* Customize the current kernel configuration.
* Build a new kernel and appropriate kernel modules.
* Install a new kernel and any modules.
* Ensure that the boot manager can locate the new kernel and associated files.
* Module configuration files
* Use DKMS to compile kernel modules.
* Awareness of dracut

**Terms and Utilities:**

* mkinitrd
* mkinitramfs
* make
* make targets \(all, config, xconfig, menuconfig, gconfig, oldconfig, mrproper, zImage, bzImage, modules, modules\_install, rpm-pkg, binrpm-pkg, deb-pkg\)
* gzip
* bzip2
* module tools
* /usr/src/linux/.config
* /lib/modules/kernel-version/
* depmod
* dkms

### Kernel

Why we should compile our linux kernel or upgrade it ? to tell the truth as linux kernel is so modular and flexible, most of the time there is no need to manipulate kernel. Specially When we are talking about commercial versions of linux like redhat, manipulating kernel cause support issues. In contrast in embedded linux system, you should try to make kernel as small as possible. So compile or upgrade kernel just if there is a good  reason.

Upgrading kernel and compiling it is very distro specific. The way that we traverse to achive that might be different in Ubuntu, Open Suse or cent OS. Upgrading kernel include compiling, so here we start with downloading new version of kernel and compiling it, but as an administrator you might recompile current version of your linux inorder to add / remove some modules and futures.

#### Upgrading kernel

First go to [https://kernel.org](https://kernel.org) inorder to get the desired kernel version:

![](/assets/KernelOrg.jpg)

We chose latest stable kernel version, do not forget we have to be in /usr/src/ and from now on work in this directory only:

```
[root@server1 ~]# cd /usr/src/
[root@server1 src]# ls -l
total 0
drwxr-xr-x. 2 root root 6 Nov  5  2016 debug
drwxr-xr-x. 2 root root 6 Nov  5  2016 kernels
[root@server1 src]# wget https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.14.3.tar.xz
--2017-12-04 08:34:00--  https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-4.14.3.tar.xz
Resolving cdn.kernel.org (cdn.kernel.org)... 151.101.1.176, 151.101.65.176, 151.101.129.176, ...
Connecting to cdn.kernel.org (cdn.kernel.org)|151.101.1.176|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 100778240 (96M) [application/x-xz]
Saving to: ‘linux-4.14.3.tar.xz’

100%[=============================================>] 100,778,240  247KB/s   in 8m 15s 

2017-12-04 08:42:20 (199 KB/s) - ‘linux-4.14.3.tar.xz’ saved [100778240/100778240]

[root@server1 src]# ls -l
total 98420
drwxr-xr-x. 2 root root         6 Nov  5  2016 debug
drwxr-xr-x. 2 root root         6 Nov  5  2016 kernels
-rw-r--r--. 1 root root 100778240 Nov 30 03:52 linux-4.14.3.tar.xz
```

Now lets extract .xz file. Also we should make a symbolic link as linux which point to downloaded kernel:

```
[root@server1 src]# tar -Jxvf linux-4.14.3.tar.xz 
********
******
****
**
[root@server1 src]# ls -l
total 98424
drwxr-xr-x.  2 root root         6 Nov  5  2016 debug
drwxr-xr-x.  2 root root         6 Nov  5  2016 kernels
drwxrwxr-x. 24 root root      4096 Nov 30 03:41 linux-4.14.3
-rw-r--r--.  1 root root 100778240 Nov 30 03:52 linux-4.14.3.tar.xz
[root@server1 src]# ln -s linux-4.14.3 linux
[root@server1 src]# ls -l
total 98424
drwxr-xr-x.  2 root root         6 Nov  5  2016 debug
drwxr-xr-x.  2 root root         6 Nov  5  2016 kernels
lrwxrwxrwx.  1 root root        12 Dec  4 08:48 linux -> linux-4.14.3
drwxrwxr-x. 24 root root      4096 Nov 30 03:41 linux-4.14.3
-rw-r--r--.  1 root root 100778240 Nov 30 03:52 linux-4.14.3.tar.xz
```

Before continue there is document folder inside downloaded kernel, There are amazing help text file:

```
[root@server1 src]# cd linux/Documentation/
[root@server1 Documentation]# ls 
00-INDEX                    gpio                         parport-lowlevel.txt
ABI                         gpu                          PCI
accounting                  hid                          pcmcia
acpi                        highuid.txt                  percpu-rw-semaphore.txt
admin-guide                 hwmon                        perf
aoe                         hw_random.txt                phy
arm                         hwspinlock.txt               phy.txt
arm64                       i2c                          pi-futex.txt
atomic_bitops.txt           ia64                         platform
atomic_t.txt                ide                          pnp.txt
auxdisplay                  iio                          power
backlight                   index.rst                    powerpc
bcache.txt                  infiniband                   pps
blackfin                    input                        preempt-locking.txt
block                       Intel-IOMMU.txt              printk-formats.txt
blockdev                    intel_txt.txt                process
bt8xxgpio.txt               ioctl                        pti
btmrvl.txt                  io-mapping.txt               ptp
bus-devices                 io_ordering.txt              pwm.txt
bus-virt-phys-mapping.txt   iostats.txt                  rapidio
cachetlb.txt                IPMI.txt                     rbtree.txt
cdrom                       IRQ-affinity.txt             RCU
cgroup-v1                   IRQ-domain.txt               remoteproc.txt
cgroup-v2.txt               irqflags-tracing.txt         rfkill.txt
Changes                     IRQ.txt                      robust-futex-ABI.txt
circular-buffers.txt        isapnp.txt                   robust-futexes.txt
clk.txt                     isa.txt                      rpmsg.txt
cma                         isdn                         rtc.txt
CodingStyle                 kbuild                       s390
conf.py                     kdump                        SAK.txt
connector                   kernel-doc-nano-HOWTO.txt    scheduler
console                     kernel-hacking               scsi
core-api                    kernel-per-CPU-kthreads.txt  security
cpu-freq                    kobject.txt                  serial
cpuidle                     kprobes.txt                  sgi-ioc4.txt
cpu-load.txt                kref.txt                     sh
cputopology.txt             laptops                      siphash.txt
crc32.txt                   ldm.txt                      SM501.txt
cris                        leds                         smsc_ece1099.txt
crypto                      lightnvm                     sound
dcdbas.txt                  livepatch                    sparc
debugging-modules.txt       locking                      sphinx
debugging-via-ohci1394.txt  lockup-watchdogs.txt         sphinx-static
dell_rbu.txt                logo.gif                     spi
device-mapper               logo.txt                     static-keys.txt
devicetree                  lsm.txt                      SubmittingPatches
dev-tools                   lzo.txt                      svga.txt
digsig.txt                  m68k                         switchtec.txt
DMA-API-HOWTO.txt           mailbox.txt                  sync_file.txt
DMA-API.txt                 Makefile                     sysctl
DMA-attributes.txt          md                           target
dmaengine                   media                        tee.txt
DMA-ISA-LPC.txt             memory-barriers.txt          thermal
doc-guide                   memory-devices               this_cpu_ops.txt
docutils.conf               memory-hotplug.txt           timers
dontdiff                    men-chameleon-bus.txt        trace
driver-api                  metag                        translations
driver-model                mic                          unaligned-memory-access.txt
early-userspace             mips                         usb
EDID                        misc-devices                 userspace-api
efi-stub.txt                mmc                          vfio-mediated-device.txt
eisa.txt                    mn10300                      vfio.txt
errseq.rst                  mtd                          video-output.txt
extcon                      namespaces                   virtual
fault-injection             netlabel                     vm
fb                          networking                   w1
features                    nfc                          watchdog
filesystems                 nios2                        wimax
firmware_class              nommu-mmap.txt               x86
flexible-arrays.txt         ntb.txt                      xillybus.txt
fmc                         numastat.txt                 xtensa
fpga                        nvdimm                       xz.txt
frv                         nvmem                        zorro.txt
futex-requeue-pi.txt        padata.txt
gcc-plugins.txt             parisc
```

Use them. Next step is making kernel with modules that we like, compile it and make other kernel required components.







