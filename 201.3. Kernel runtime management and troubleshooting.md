### **201.3 Kernel runtime management and troubleshooting**

**Weight:** 4

**Description: **Candidates should be able to manage and/or query a 2.6.x, 3.x or 4.x kernel and its loadable modules. Candidates should be able to identify and correct common boot and run time issues. Candidates should understand device detection and management using udev. This objective includes troubleshooting udev rules.

**Key Knowledge Areas:**

* Use command-line utilities to get information about the currently running kernel and kernel modules
* Manually load and unload kernel modules
* Determine when modules can be unloaded
* Determine what parameters a module accepts
* Configure the system to load modules by names other than their file name.
* /proc filesystem
* Content of /, /boot/ , and /lib/modules/
* Tools and utilities to analyze information about the available hardware
* udev rules

**Terms and Utilities:**

* /lib/modules/kernel-version/modules.dep
* module configuration files in /etc/
* /proc/sys/kernel/
* /sbin/depmod
* /sbin/rmmod
* /sbin/modinfo
* /bin/dmesg
* /sbin/lspci
* /usr/bin/lsdev
* /sbin/lsmod
* /sbin/modprobe
* /sbin/insmod
* /bin/uname
* /usr/bin/lsusb
* /etc/sysctl.conf, /etc/sysctl.d/
* /sbin/sysctl
* udevmonitor
* udevadm monitor
* /etc/udev/

### Kernel Modules

Linux Kernel is modular since version 2.0. Being modular make simplicity and efficiency, the code which is not needed wouldn't be loaded. Kernel Modules have different conditions. A module might be compiled, or not. If it has already compiled it might be loaded or not. So Loading an unload but compiled kernel is easy, otherwise required kernel manipulation.

#### lsmod

To list Kernel Loaded modules use lsmod

```
root@server1:~# lsmod
Module                  Size  Used by
bnep                   20480  2
nfnetlink_queue        24576  0
nfnetlink_log          20480  0
nfnetlink              16384  2 nfnetlink_log,nfnetlink_queue
bluetooth             557056  7 bnep
vmw_vsock_vmci_transport    28672  2
vsock                  36864  3 vmw_vsock_vmci_transport
vmw_balloon            20480  0
crct10dif_pclmul       16384  0
crc32_pclmul           16384  0
ghash_clmulni_intel    16384  0
snd_ens1371            28672  4
snd_ac97_codec        131072  1 snd_ens1371
gameport               16384  1 snd_ens1371
ac97_bus               16384  1 snd_ac97_codec
pcbc                   16384  0
snd_pcm               102400  2 snd_ac97_codec,snd_ens1371
aesni_intel           167936  0
aes_x86_64             20480  1 aesni_intel
snd_seq_midi           16384  0
snd_seq_midi_event     16384  1 snd_seq_midi
crypto_simd            16384  1 aesni_intel
snd_rawmidi            32768  2 snd_seq_midi,snd_ens1371
snd_seq                65536  2 snd_seq_midi_event,snd_seq_midi
glue_helper            16384  1 aesni_intel
cryptd                 24576  3 crypto_simd,ghash_clmulni_intel,aesni_intel
intel_rapl_perf        16384  0
snd_seq_device         16384  3 snd_seq,snd_rawmidi,snd_seq_midi
snd_timer              32768  2 snd_seq,snd_pcm
input_leds             16384  0
joydev                 20480  0
serio_raw              16384  0
i2c_piix4              24576  0
shpchp                 36864  0
snd                    77824  15 snd_seq,snd_ac97_codec,snd_timer,snd_rawmidi,snd_ens1371,snd_seq_device,snd_pcm
soundcore              16384  1 snd
vmw_vmci               69632  2 vmw_balloon,vmw_vsock_vmci_transport
nfit                   49152  0
mac_hid                16384  0
parport_pc             32768  0
ppdev                  20480  0
lp                     20480  0
parport                49152  3 lp,parport_pc,ppdev
autofs4                40960  2
vmw_pvscsi             24576  0
vmxnet3                61440  0
hid_generic            16384  0
usbhid                 53248  0
hid                   118784  2 hid_generic,usbhid
vmwgfx                241664  3
ttm                    98304  1 vmwgfx
drm_kms_helper        151552  1 vmwgfx
mptspi                 24576  2
syscopyarea            16384  1 drm_kms_helper
mptscsih               40960  1 mptspi
sysfillrect            16384  1 drm_kms_helper
psmouse               139264  0
sysimgblt              16384  1 drm_kms_helper
mptbase               102400  2 mptscsih,mptspi
fb_sys_fops            16384  1 drm_kms_helper
ahci                   36864  0
e1000                 143360  0
drm                   352256  6 vmwgfx,ttm,drm_kms_helper
libahci                32768  1 ahci
scsi_transport_spi     32768  1 mptspi
pata_acpi              16384  0
fjes                   77824  0
```

lets try to load and unloaded module " jfs " that old journaling file system. for loading an unloaded but compiled module there are two  solutions. An old solution is insmod , lets try it first

```
root@server1:~# insmod jfs
insmod: ERROR: could not load module jfs: No such file or directory
```

But it doesn't work :\(\( so let get more information about "jfs" module with modinfo:

```
root@server1:~# modinfo jfs
filename:       /lib/modules/4.10.0-40-generic/kernel/fs/jfs/jfs.ko
alias:          fs-jfs
license:        GPL
author:         Steve Best/Dave Kleikamp/Barry Arndt, IBM
description:    The Journaled Filesystem (JFS)
srcversion:     3249CD436BA490FF745560A
depends:        
intree:         Y
vermagic:       4.10.0-40-generic SMP mod_unload 
parm:           nTxBlock:Number of transaction blocks (max:65536) (int)
parm:           nTxLock:Number of transaction locks (max:65536) (int)
parm:           commit_threads:Number of commit threads (int)
```

modinfo shows a bunch of information about a module. Like its filename, dependencies and possible parameters.Till now we have realize that "jfs" module has been compiled and its available but it is not loaded. inorder to load a module with insmod we have to specify the full patch of module:

```
root@server1:~# insmod /lib/modules/4.10.0-40-generic/kernel/fs/jfs/jfs.ko
root@server1:~# lsmod | grep jfs
jfs                   184320  0
```

Haha its loaded now, Lets remove it by using rmmod:

```
root@server1:~# lsmod | grep jfs
jfs                   184320  0
root@server1:~# 
root@server1:~# rmmod jfs
root@server1:~# lsmod | grep jfs
```

But as you see using insmod is not that much easy, insmod has another problem and that is dependencies. "jfs" module has no dependency so we were able to load it very easily, if a module has some dependencies, insmod dosn't load those required dependencies automatically. So it would be administrator task. All these shortages cause we come to this conclusion that insmod is not perfect and we need a modern tool, which automatically know the patch and load required dependencies, that is modprobe.

```
root@server1:~# lsmod | grep lp
lp                     20480  0
glue_helper            16384  1 aesni_intel
parport                49152  1 lp
drm_kms_helper        151552  1 vmwgfx
syscopyarea            16384  1 drm_kms_helper
sysfillrect            16384  1 drm_kms_helper
sysimgblt              16384  1 drm_kms_helper
fb_sys_fops            16384  1 drm_kms_helper
drm                   352256  6 vmwgfx,ttm,drm_kms_helper
root@server1:~# modinfo lp
filename:       /lib/modules/4.10.0-40-generic/kernel/drivers/char/lp.ko
license:        GPL
alias:          char-major-6-*
srcversion:     5273B3FB623D57CACC37C09
depends:        parport
intree:         Y
vermagic:       4.10.0-40-generic SMP mod_unload 
parm:           parport:array of charp
parm:           reset:bool
root@server1:~# modinfo parport
filename:       /lib/modules/4.10.0-40-generic/kernel/drivers/parport/parport.ko
license:        GPL
srcversion:     CED357203546F0957229054
depends:        
intree:         Y
vermagic:       4.10.0-40-generic SMP mod_unload 
root@server1:~# rmmod lp
root@server1:~# rmmod parport
root@server1:~# insmod /lib/modules/4.10.0-40-generic/kernel/drivers/char/lp.ko
insmod: ERROR: could not insert module /lib/modules/4.10.0-40-generic/kernel/drivers/char/lp.ko: Unknown symbol in module
root@server1:~# modprobe lp
root@server1:~# lsmod | grep lp
lp                     20480  0
parport                49152  1 lp
glue_helper            16384  1 aesni_intel
drm_kms_helper        151552  1 vmwgfx
syscopyarea            16384  1 drm_kms_helper
sysfillrect            16384  1 drm_kms_helper
sysimgblt              16384  1 drm_kms_helper
fb_sys_fops            16384  1 drm_kms_helper
drm                   352256  6 vmwgfx,ttm,drm_kms_helper
```

also for removing  use modprobe -r lp. But how modprobe realize module dependencies and act such a smart tool? modules.dep 

```
root@server1:~# cd /lib/modules/
root@server1:/lib/modules# ls
4.10.0-28-generic  4.10.0-40-generic
root@server1:/lib/modules# cd 4.10.0-40-generic/
root@server1:/lib/modules/4.10.0-40-generic# ls
build          modules.alias.bin    modules.dep.bin  modules.symbols
initrd         modules.builtin      modules.devname  modules.symbols.bin
kernel         modules.builtin.bin  modules.order    vdso
modules.alias  modules.dep          modules.softdep
root@server1:/lib/modules/4.10.0-40-generic# depmod -a
```

we can use depmod -a to create and update modules.dep with all new modules and dependencies. Now that we have learned alot of tools, let play game with cdrom parameters \[in ubunto cdrom is not a module, so use other distro\]:

```
[root@server1 ~]# lsmod | grep cdrom
cdrom                  42556  1 sr_mod
[root@server1 ~]# modinfo cdrom
filename:       /lib/modules/3.10.0-693.el7.x86_64/kernel/drivers/cdrom/cdrom.ko.xz
license:        GPL
rhelversion:    7.4
srcversion:     BE3BD0D17D080229D55B173
depends:        
intree:         Y
vermagic:       3.10.0-693.el7.x86_64 SMP mod_unload modversions 
signer:         CentOS Linux kernel signing key
sig_key:        DA:18:7D:CA:7D:BE:53:AB:05:BD:13:BD:0C:4E:21:F4:22:B6:A4:9C
sig_hashalgo:   sha256
parm:           debug:bool
parm:           autoclose:bool
parm:           autoeject:bool
parm:           lockdoor:bool
parm:           check_media_type:bool
parm:           mrw_format_restart:bool
[root@server1 ~]# modprobe cdrom lookdoor=1
```

and how to make these

As we have learned in lPIC1 for monitoring kernel events we can use dmseg

