### **202.2 System Recovery**

**Weight:** 4

**Description:** Candidates should be able to properly manipulate a Linux system during both the boot process and during recovery mode. This objective includes using both the init utility and init-related kernel options. Candidates should be able to determine the cause of errors in loading and usage of bootloaders. GRUB version 2 and GRUB Legacy are the bootloaders of interest. Both BIOS and UEFI systems are covered.

**Key Knowledge Areas:**

* BIOS and UEFI
* NVMe booting
* GRUB version 2 and Legacy
* grub shell
* boot loader start and hand off to kernel
* kernel loading
* hardware initialisation and setup
* daemon/service initialisation and setup
* Know the different boot loader install locations on a hard disk or removable device.
* Overwrite standard boot loader options and using boot loader shells.
* Use systemd rescue and emergency modes.

**Terms and Utilities:**

* mount
* fsck
* inittab, telinit and init with SysV init
* The contents of /boot/, /boot/grub/ and /boot/efi/
* EFI System Partition \(ESP\)
* GRUB
* grub-install
* efibootmgr
* UEFI shell
* initrd, initramfs
* Master boot record
* systemctl

#### Boot process overview

lets take a look at boot process and stick what ever we have learned till now:

```
BIOS / UEFI
    |
    Bootable Disk
        |
        Boot Loader(LILO,Grub,Grub2)
            |
            Kernel (initramfs/initd)
                |
                init --->systemd / upstart / SysV
                            |
                            everything---shell & other services and programs
```

if any problems occur on any of these steps, boot process fails. It might be motherboard  problems, Disk problems or boot loader problem.

### Boot Loader Recovery General Notes

Recovering boot loader needs to specify three major required elements. We have already got familiar with all 3:

1. root partion
2. kernel and boot partition as its argument \(usually same as root\)
3. initrd/initramfs 

how ever some commands are different in grub version 1 and version 2.

* #### Recovering Grub Legacy

grub version1 dosn't have "ls" command.Do not forget it starts counting hard disk partitions from "Zero".

```
grub>help ###to see grub v1 commands

###1.root,What the root is ?
grub>root ### if nothing showed up, we have to boot system by using another media

###2.Kernel, which kernel we want to boot from? nad where is the boot partition? consider lvm :(
grub> kernel /vmlinuz.x.y.z root=/dev/sdaX

###3.initramfs/initrd , Which initramdisk is going to be loaded? It should be the same as kernel version
grub>initrd /initrd-x.y.z 

### and finally boot the system
grub>boot
```

after rebooting system install grub again:

    [root@localhost ~]# grub-install /dev/sda
    Installation finished. No error reported.
    This is the contents of the device map /boot/grub/device.map.
    Check if this is correct or not. If any of the lines is incorrect,
    fix it and re-run the script `grub-install'.

    # this device map was generated by anaconda
    (hd0)     /dev/sda

* #### Recovering Grub2

Grub2 is more enhanced than legacy grab and if boot problems occur, grub might left system in different states.[^1]

| grub command prompt | Description |  |
| :--- | :--- | :--- |
| grub&gt; | prompt | GRUB 2 loaded modules but was unable to find the grub.cfg file. = has already found root partition |
| grub rescue&gt; | prompt | GRUB 2 failed to find its grub folder, or failed to load the normal module. = has not found root partition |
| grub&gt;: | The grub prompt on a blank screen | GRUB 2 has found the boot information but has been either unable to locate or unable to use an existing GRUB 2 configuration file \(usually grub.cfg\) |
| grub rescue&gt;: | the rescue mode | GRUB 2 is unable to find the grub folder or its contents are missing/corrupted. The grub folder contains the GRUB 2 menu, modules and stored environmental data. |
| GRUB- | a single word, with no prompt and no curser | GRUB has failed to find even the most basic information, usually contained in the MBR or boot sector. |
|  | Busybox or Initramfs | GRUB 2 began the boot process but there was a problem passing control to the operating system. Possible causes include an incorrect UUID or root= designation in the 'linux' line or a corrupted kernel. |
|  | Frozen splash screen | blinking cursor with no grub&gt; or grub rescue prompt. Possible video issues with the kernel. While these failures are not of GRUB 2's making, it may still be able to help. GRUB 2 allows pre-boot editing of its menu and the user may restore functionality by adding and/or removing kernel options in a menuentry before booting. |

each failer might need different remedies here lets take a look at the first one. Grub2 supports "ls" , "cat" command and support tab tab completion. it starts counting partitions from "One" . Strange world huuh ?

```
###1.root, Finding root partition --- no "root command" in grub2
grub>ls ### to see partitions, (hdX,A) (hdX,B) (hdX,C) , ...
grub>ls (hdX,A) ###try to guess based on content, setting root partition in grub 2 is different from grub 1
grub>set ###it show all current grub2 variables, we should check/create/fix two of them:
         ###prefix=(hdX,A)/boot/grub
         ###root=hdX,A
grub>set root=(hdA,Y) ###set/modify required variables base on information that we have got from ls
grub>set ###check results

###2.kernel, introducing kernel --- no "kernel command" in grub 2
grub>linux /boot/vmlinux.x.y.z root=/dev/sdY

###3.initramfs/initrd, give appropriate initramdisk for kernel , consider versions 
grub>initrd /boot/init.img.x.y.z

###and finally
grub>boot
```



[^1]: [https://help.ubuntu.com/community/Grub2/Troubleshooting](https://help.ubuntu.com/community/Grub2/Troubleshooting)

