# **Topic 200: Capacity Planning**

### **200.1 Measure and Troubleshoot Resource Usage**

**Weight:** 6

**Description:** Candidates should be able to measure hardware resource and network bandwidth, identify and troubleshoot resource problems.

**Key Knowledge Areas:**

* Measure CPU usage
* Measure memory usage
* Measure disk I/O
* Measure network I/O
* Measure firewalling and routing throughput
* Map client bandwidth usage
* Match / correlate system symptoms with likely problems
* Estimate throughput and identify bottlenecks in a system including networking

**The following is a partial list of the used files, terms and utilities:**

* iostat
* netstat
* w
* top
* sar
* processes blocked on I/O
* blocks out
* vmstat
* pstree, ps
* Isof
* uptime
* swap
* blocks in

Computers hang, People Nags and Applications run with lags. Handling all of this problems is on administrators' shoulders. It doesn't matter if we are talking about a single computer or we are some where in the cloud. We need some tools to explore the behavior of a system in order to find a solution. Performance problems have two main roots, Sometimes lack of system resources such as CPU, Memory, HDD or even Network cause them, Sometimes we as humankind make mistakes. When there is a paradox between what we expect, what is in need and how we configure computers hang.

### Measure memory usage

RAM is like a gateway of a town, everything goes through RAM. If we have a process, it should be loaded in RAM first inorder to be served by CPU later. CPU feeds its Caches from RAM data. How about User activities? If user ask to read some data From HardDisk it is loaded in RAM and then user can work with that.

![](/assets/200.1-bigpicture.jpg)

As it seeam RAM is pretty busy and always in need.Linux uses some Techniques to over come problem, to make it simple lets explain Memory Terminology

| Item | Description |
| :--- | :--- |
| Page | The blocks that are used in memory, Ususally 4K size |
| Paging | Used to get memory from secondary storage to primary storage |
| Swap | emulated memory  on HDD |
| Virtual Memory | Total allocatable  memory, \[known as process address space\]Linux supports Tera Bytes of virtual memory and use TLB to allocate physial memory. |
| Translation Look aside Buffer\(TLB\) | Kind of cache which speedup translation between RAM and virtual memory, stored in RAM |
| Page cache | Recently used  memory pages are stored here\(not cpu cache \) Used for parked data |
| Dirty Cache | Data which are waiting to go to HDD from RAM\(Works Like a buffer\) |
| Buffers | Used for some Block devices and cache file system metadata.not really important |

Lets explorer whats going inside with some tools and commands.

```
root@server1:~# vmstat
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 2  0  98012  79256  12136 319060    4   17   170    93   85  174  4  1 95  0  0
```

the command vmstat show virtual memory status and some other information. For periodic check with interval you can use `vmstat 2 5`. Lets try free command:

```
root@server1:~# free -h
              total        used        free      shared  buff/cache   available
Mem:           971M        637M         93M         36M        241M        116M
Swap:          1.0G        403M        617M
```

if you use -h option you can see human readable values, you can use `-m` for megabyte and `-g` for gigabyte view.

as you can see  241M is allocated to buff/cache.  to clear buff/cache:

`echo 3 > /proc/sys/vm/drop_caches ; free -h`

this system just has 1 GigaByte of Ram, so obviously it starts using swap,  Whats swappiness?

Swappiness is the kernel parameter that defines how much \(and how often\) your Linux kernel will copy RAM contents to swap. This parameter's default value is “60” and it can take anything from “0” to “100”. The higher the value of the swappiness parameter, the more aggressively your kernel will swap.

```
root@server1:~# cd /proc/sys/vm/
root@server1:/proc/sys/vm# cat swappiness 
60
root@server1:/proc/sys/vm# echo 90 > swappiness
```

### Monitoring CPU

Sometimes CPU is the bottleneck. top command is here to help us:

```
top - 05:06:59 up  6:04,  1 user,  load average: 0.44, 0.16, 0.05
Tasks: 239 total,   3 running, 236 sleeping,   0 stopped,   0 zombie
%Cpu(s): 98.9 us,  1.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem :   994868 total,    77944 free,   594552 used,   322372 buff/cache
KiB Swap:  1045500 total,   571124 free,   474376 used.   180436 avail Mem 

   PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND     
  8738 root      20   0    7480     96      0 R 93.0  0.0   0:26.89 stress      
  7478 myuser     20   0  884192 110216  48640 S  4.7 11.1   4:01.21 oxide-rend+ 
     1 root      20   0  185136   3436   2300 S  0.0  0.3   0:03.40 systemd     
     2 root      20   0       0      0      0 S  0.0  0.0   0:00.01 kthreadd    
     4 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:+ 
     6 root      20   0       0      0      0 S  0.0  0.0   0:04.64 ksoftirqd/0 
     7 root      20   0       0      0      0 R  0.0  0.0   0:04.30 rcu_sched   
     8 root      20   0       0      0      0 S  0.0  0.0   0:00.00 rcu_bh      
     9 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0 
    10 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 lru-add-dr+ 
    11 root      rt   0       0      0      0 S  0.0  0.0   0:00.10 watchdog/0  
    12 root      20   0       0      0      0 S  0.0  0.0   0:00.00 cpuhp/0     
    13 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kdevtmpfs   
    14 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 netns       
    15 root      20   0       0      0      0 S  0.0  0.0   0:00.09 khungtaskd  
    16 root      20   0       0      0      0 S  0.0  0.0   0:00.00 oom_reaper  
    17 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 writeback   
```

top command gives us information about system uptime, load avarage, and detailed info about processes. top also has some tricks:

| Key | Description |
| :--- | :--- |
| press "1" | shows all cpu cores load  |
| "shift" + "&lt;" or "&gt;" | sort top based on different culoms |
| "shift" + "p" | sort based CPU usage |
| "shift" + "m" | sort based memory usage |
| press "c" | shows absolute patch of process |
| press "z" | will running process in color |
| press "d" and then delay number | by default top command runs every 3.0 second |
| press "k" and insetr PID of process | Kill the process by using PID |
| press "r"  and PID of process | to renice a process |
| "shift" + "w" | ro write top command results |
| press "q" | to exit |



top command is usefull for monitoring both CPU and RAM.Lets clarify items in CPU line:



