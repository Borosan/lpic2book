### **205.2 Advanced Network Configuration and Troubleshooting**

**Weight:** 4

**Description:** Candidates should be able to configure a network device to implement various network authentication schemes. This objective includes configuring a multi-homed network device and resolving communication problems.

**Key Knowledge Areas:**

* Utilities to manipulate routing tables
* Utilities to configure and manipulate ethernet network interfaces
* Utilities to analyze the status of the network devices
* Utilities to monitor and analyze the TCP/IP traffic

**Terms and Utilities:**

* ip
* ifconfig
* route
* arp
* ss
* netstat
* lsof
* ping, ping6
* nc
* tcpdump
* nmap

In this lesson we discuss about some other Network tools which help up in network trouble shooting.

#### What is socket?

In computer networking, and more definitely in software terms, a port is a logical entity which acts as a endpoint of communication to identify a given application or process on an Linux operating system. It is a 16-bit number \(0 to 65535\) which differentiates one application from another on end systems. Different categories of ports are:

* 0-1023 – the Well Known Ports, also referred to as System Ports.
* 1024-49151 – the Registered Ports, also known as User Ports.
* 49152-65535 – the Dynamic Ports, also referred to as the Private Ports.

The two most popular Internet transport protocols, Transmission Control Protocol \(TCP\) and the User Datagram Protocol \(UDP\) and other less known protocols use port numbers for communication sessions.

A combination of an IP address, port and protocol such as TCP/UDP is known as a socket, and every service must have a unique socket.

### netstat

netstat \(network statistics\)outputs network connections form local host perspective, routing, interface statistics, connections and multicast information. so its pretty handy.

```
root@server1:~# netstat 
Active Internet connections (w/o servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        1      0 192.168.10.152:44480    hanger.canonical.c:http CLOSE_WAIT 
tcp        0      0 192.168.10.152:42844    yukinko.canonical.:http ESTABLISHED
udp        0      0 localhost:57079         ubuntu:domain           ESTABLISHED
udp        0      0 localhost:47407         ubuntu:domain           ESTABLISHED
Active UNIX domain sockets (w/o servers)
Proto RefCnt Flags       Type       State         I-Node   Path
unix  2      [ ]         DGRAM                    26445    /run/user/1000/systemd/notify
unix  2      [ ]         DGRAM                    22660    /run/user/108/systemd/notify
unix  9      [ ]         DGRAM                    15796    /run/systemd/journal/socket
unix  2      [ ]         DGRAM                    15797    /run/systemd/journal/syslog
unix  20     [ ]         DGRAM                    15798    /run/systemd/journal/dev-log
unix  3      [ ]         DGRAM                    14516    /run/systemd/notify
unix  3      [ ]         STREAM     CONNECTED     27303    
unix  3      [ ]         DGRAM                    16955    
unix  3      [ ]         STREAM     CONNECTED     23403    @/tmp/dbus-0tx8y6voha
unix  3      [ ]         STREAM     CONNECTED     30750    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     23522    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     28047    
unix  3      [ ]         STREAM     CONNECTED     22005    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     28223    @/tmp/dbus-K7JvDcncxI
unix  3      [ ]         STREAM     CONNECTED     22006    /run/systemd/journal/stdout
unix  3      [ ]         DGRAM                    28279    
unix  3      [ ]         STREAM     CONNECTED     27098    /var/run/dbus/system_bus_socket
unix  3      [ ]         STREAM     CONNECTED     28737    /var/run/cups/cups.sock
unix  3      [ ]         STREAM     CONNECTED     18372    /var/run/dbus/system_bus_socket
unix  3      [ ]         STREAM     CONNECTED     29963    
unix  3      [ ]         DGRAM                    16958    
unix  3      [ ]         STREAM     CONNECTED     23372    
unix  3      [ ]         STREAM     CONNECTED     22015    
unix  2      [ ]         DGRAM                    18086    
unix  3      [ ]         STREAM     CONNECTED     30009    
unix  3      [ ]         STREAM     CONNECTED     23529    /var/run/dbus/system_bus_socket
unix  3      [ ]         STREAM     CONNECTED     18188    /var/run/dbus/system_bus_socket
unix  3      [ ]         STREAM     CONNECTED     28042    
unix  3      [ ]         STREAM     CONNECTED     19237    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     30014    @/tmp/dbus-K7JvDcncxI
unix  3      [ ]         STREAM     CONNECTED     23289    
unix  3      [ ]         STREAM     CONNECTED     29849    
unix  3      [ ]         STREAM     CONNECTED     28050    @/com/ubuntu/upstart-session/1000/2169
unix  3      [ ]         STREAM     CONNECTED     23332    @/tmp/.X11-unix/X0
unix  3      [ ]         STREAM     CONNECTED     30806    
unix  2      [ ]         DGRAM                    22687    
unix  3      [ ]         STREAM     CONNECTED     27237    
unix  3      [ ]         STREAM     CONNECTED     28915    
unix  3      [ ]         STREAM     CONNECTED     26586    
unix  3      [ ]         STREAM     CONNECTED     24238    /run/systemd/journal/stdout
unix  2      [ ]         DGRAM                    22556    
unix  3      [ ]         STREAM     CONNECTED     27263    
unix  3      [ ]         STREAM     CONNECTED     30005    @/tmp/.X11-unix/X0
unix  3      [ ]         STREAM     CONNECTED     27232    
unix  3      [ ]         STREAM     CONNECTED     27174    @/tmp/dbus-K7JvDcncxI
unix  3      [ ]         STREAM     CONNECTED     18371    /var/run/dbus/system_bus_socket
unix  3      [ ]         STREAM     CONNECTED     25098    
unix  3      [ ]         STREAM     CONNECTED     17382    
unix  3      [ ]         STREAM     CONNECTED     28751    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     23256    
unix  3      [ ]         STREAM     CONNECTED     19416    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     27276    @/tmp/dbus-K7JvDcncxI
unix  3      [ ]         STREAM     CONNECTED     19418    /run/systemd/journal/stdout
unix  3      [ ]         STREAM     CONNECTED     28226    @/tmp/dbus-K7JvDcncxI
unix  3      [ ]         STREAM     CONNECTED     23528    
unix  3      [ ]         STREAM     CONNECTED     29966    
unix  3      [ ]         DGRAM                    16957    
unix  3      [ ]         STREAM     CONNECTED     19739    /var/run/dbus/system_
.....
....
..
.
```

netstat it self give us a log list of network information which might not be useful, so lets try some useful switches:

| useful netstat command switches | Description |
| :--- | :--- |
| -s , --statistics | gives summary by protocol type and message type |
| -i , --interfaces | Display a table of all network interfaces |
| -r , --route | shows  routing table  information |
| -a , --all | Show both listening and non-listening sockets |
| -t , --tcp | Enabales listening of tcp ports |
| -u , --udp | Enables listening of udp ports |
| -l , --listening | Prints only listening  sockets |
| -p , --program | Shows PID and the name of associated program |
| -e , --extend | Shows additional information, use twice for more info |
| -n , --numeric | Shows numerical addresses |

netstat supports ipv6.

### ss

The ss command is capable of showing more information than the netstat and is faster. The netstat command reads various /proc files to gather information. However this approach falls weak when there are lots of connections to display. This makes it slower.

The ss command gets its information directly from kernel space. The options used with the ss commands are very similar to netstat making it an easy replacement.

If we use the ss command without any arguments or options, it will return a complete list of TCP sockets with established connections:

```
Netid  State      Recv-Q Send-Q Local Address:Port                 Peer Address:Port                
u_str  ESTAB      0      0       * 23433                 * 27689                
u_str  ESTAB      0      0       * 19210                 * 19211                
u_str  ESTAB      0      0       * 28948                 * 30007                
u_str  ESTAB      0      0       * 23378                 * 25314                
u_str  ESTAB      0      0      @/tmp/dbus-FSfvGgFOBN 23345                 * 25
283                
u_str  ESTAB      0      0       * 30024                 * 28207                
u_str  ESTAB      0      0       * 27840                 * 23551                
u_str  ESTAB      0      0      @/tmp/dbus-FSfvGgFOBN 25388                 * 23
459                
u_str  ESTAB      0      0      @/tmp/dbus-FSfvGgFOBN 29978                 * 31
023                
u_str  ESTAB      0      0      @/tmp/.X11-unix/X0 30930                 * 28156

u_str  ESTAB      0      0      /run/systemd/journal/stdout 28986               
  * 31082                
u_str  ESTAB      0      0      @/tmp/dbus-FSfvGgFOBN 27007                 * 23
483                
u_str  ESTAB      0      0      /var/run/dbus/system_bus_socket 20007           
      * 19011                
u_str  ESTAB      0      0       * 28949                 * 30010                
--More--
```

| useful ss command | Description |
| :--- | :--- |
| -l , --listening | Display only listening sockets |
| -4 | for IPv4 |
| -6 | for IPv6 |
| -a , --all | Display both listening and non-listening \(for TCP this means established connections\) sockets |
| -t , --tcp | Shows established or CONNECTED tcp connections |
| -u , --udp | Shows established or CONNECTED tcp connections |
| -s , --summary | Print summary statistics. |
| -o , --options | time information of each connection would be displayed |
| -n , --numeric | Do not try to resoleve service names |

### lsof

To get a list of files which are opened by users and associated processes with them we use lsof \(LiSt Open Files\).

```
root@server1:~# lsof | more
COMMAND    PID  TID             USER   FD      TYPE             DEVICE SIZE/OFF       NODE NAME
systemd      1                  root  cwd       DIR                8,1     4096          2 /
systemd      1                  root  rtd       DIR                8,1     4096          2 /
systemd      1                  root  txt       REG                8,1  1577232     135885 /lib/systemd/systemd
systemd      1                  root  mem       REG                8,1    18976     136484 /lib/x86_64-linux-gnu/libuuid.so.1.3.0
systemd      1                  root  mem       REG                8,1   262408     136292 /lib/x86_64-linux-gnu/libblkid.so.1.1.0
systemd      1                  root  DEL       REG                8,1              136324 /lib/x86_64-linux-gnu/libdl-2.23.so
systemd      1                  root  mem       REG                8,1   456632     136429 /lib/x86_64-linux-gnu/libpcre.so.3.13.2
systemd      1                  root  DEL       REG                8,1              136300 /lib/x86_64-linux-gnu/libc-2.23.so
systemd      1                  root  DEL       REG                8,1              136446 /lib/x86_64-linux-gnu/libpthread-2.23.so
systemd      1                  root  mem       REG                8,1   286824     136376 /lib/x86_64-linux-gnu/libmount.so.1.1.0
systemd      1                  root  mem       REG                8,1    64144     136282 /lib/x86_64-linux-gnu/libapparmor.so.1.4.0
systemd      1                  root  mem       REG                8,1    92864     136363 /lib/x86_64-linux-gnu/libkmod.so.2.3.0
systemd      1                  root  mem       REG                8,1   117288     136290 /lib/x86_64-linux-gnu/libaudit.so.1.0.0
systemd      1                  root  mem       REG                8,1    55904     136416 /lib/x86_64-linux-gnu/libpam.so.0.83.1
systemd      1                  root  mem       REG                8,1   252152     136457 /lib/x86_64-linux-gnu/libseccomp.so.2.2.3
```

| lsof useful commmands | Description |
| :--- | :--- |
| lsof -n | Do not tries to resolve IP Addresses to DNS |
| lsof  /var/log/syslog | Shows which processes have opened specific file |
| lsof +D /var/log | List opened files under a Directory |
| lsof /home | List processes using a mount point |
| lsof -u payam | List files opened by a specific user |
| lsof -p 1357 | all open files by specific process |
| lsof -c ssh | List opened files based on process names starting with ... |
| lsof -t /var/log/syslog | list process id of a process which opened /var/log/syslog |
| lsof -i | list all network connections |

### nc

Netcat \(also known as ‘nc’ or ‘Swiss Army knife’\) is a networking utility used for reading or writing from TCP and UDP sockets using an easy interface. Netcat is used by Administrators, Developers and pen testers because of its features.

      .       .       
      \`-"'"-'/       
       } 6 6 {        
      ==. Y ,==       
        /^^^\  .      
       /     \  )     
      (  )-(  )/     _
      -""---""---   / 
     /           \_/  
    (     ____        
     \_.=|____E 

    root@server1:~# nc
    This is nc from the netcat-openbsd package. An alternative nc is available
    in the netcat-traditional package.
    usage: nc [-46bCDdhjklnrStUuvZz] [-I length] [-i interval] [-O length]
    	  [-P proxy_username] [-p source_port] [-q seconds] [-s source]
    	  [-T toskeyword] [-V rtable] [-w timeout] [-X proxy_protocol]
    	  [-x proxy_address[:port]] [destination] [port]


With netcat \(nc\) we can setup kind of client server connection over a specific port. For demo lets start chatting  between two  servers, server1 starts listening on port 12345:

```
root@server1:~# nc -l 12345
```

send text stream from server2 to server1:

```
root@server2:~$ su 
Password: 
root@server2:/home/payam# su -
root@server2:~# nc 192.168.10.152 80
Hello!
I'm here to send some messages over port 80
using netcat :)
```

and see the result on server1:

```
Hello!
I'm here to send some messages over port 80
using netcat :)
```

| netcat useful switches | Description |
| :--- | :--- |
| -4 | Forces nc to use IP v4 only |
| -6 | Forces nc to use IP v6 only |
| -v | Give more verbose output |
| -n | Do not DNS Lookup for IP Addresses, Host Name or ports |
| -k | allow server to  continue listening  after client disconnect |
| -u | use udp |
| -w | setting up time out |

also we can use nc for prt scanning although netcat is not the best tool for the job:

```
root@server2:~# nc -v 192.168.10.152 -z 12340-12346
nc: connect to 192.168.10.152 port 12340 (tcp) failed: Connection refused
nc: connect to 192.168.10.152 port 12341 (tcp) failed: Connection refused
nc: connect to 192.168.10.152 port 12342 (tcp) failed: Connection refused
nc: connect to 192.168.10.152 port 12343 (tcp) failed: Connection refused
nc: connect to 192.168.10.152 port 12344 (tcp) failed: Connection refused
Connection to 192.168.10.152 12345 port [tcp/*] succeeded!
nc: connect to 192.168.10.152 port 12346 (tcp) failed: Connection refused
```

-z says that nc should just scan for listening daemons, without sending any data to them. can not be used with -l option.

### nmap

Nmap \(Network Mapper\) is a security scanner.It is used to discover hosts and services on a computer network, whith the goal of building a "map" of the network. To accomplish it, Nmap sends specially designed packets to the target host\(s\) and then analyzes the responses.

![](/assets/sitelogo-transparent-googleplus.png)

nmap has some features like host discovery and service and operating-system detection. Nmap can adapt to network conditions including latency and congestion during a scan.

```
root@server2:~# nmap
Nmap 7.01 ( https://nmap.org )
Usage: nmap [Scan Type(s)] [Options] {target specification}
TARGET SPECIFICATION:
  Can pass hostnames, IP addresses, networks, etc.
  Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.0-255.1-254
  -iL <inputfilename>: Input from list of hosts/networks
  -iR <num hosts>: Choose random targets
  --exclude <host1[,host2][,host3],...>: Exclude hosts/networks
  --excludefile <exclude_file>: Exclude list from file
HOST DISCOVERY:
  -sL: List Scan - simply list targets to scan
  -sn: Ping Scan - disable port scan
  -Pn: Treat all hosts as online -- skip host discovery
  -PS/PA/PU/PY[portlist]: TCP SYN/ACK, UDP or SCTP discovery to given ports
  -PE/PP/PM: ICMP echo, timestamp, and netmask request discovery probes
  -PO[protocol list]: IP Protocol Ping
  -n/-R: Never do DNS resolution/Always resolve [default: sometimes]
  --dns-servers <serv1[,serv2],...>: Specify custom DNS servers
  --system-dns: Use OS's DNS resolver
  --traceroute: Trace hop path to each host
SCAN TECHNIQUES:
  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
  -sU: UDP Scan
  -sN/sF/sX: TCP Null, FIN, and Xmas scans
  --scanflags <flags>: Customize TCP scan flags
  -sI <zombie host[:probeport]>: Idle scan
  -sY/sZ: SCTP INIT/COOKIE-ECHO scans
  -sO: IP protocol scan
  -b <FTP relay host>: FTP bounce scan
PORT SPECIFICATION AND SCAN ORDER:
  -p <port ranges>: Only scan specified ports
    Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
  --exclude-ports <port ranges>: Exclude the specified ports from scanning
  -F: Fast mode - Scan fewer ports than the default scan
  -r: Scan ports consecutively - don't randomize
  --top-ports <number>: Scan <number> most common ports
  --port-ratio <ratio>: Scan ports more common than <ratio>
SERVICE/VERSION DETECTION:
  -sV: Probe open ports to determine service/version info
  --version-intensity <level>: Set from 0 (light) to 9 (try all probes)
  --version-light: Limit to most likely probes (intensity 2)
  --version-all: Try every single probe (intensity 9)
  --version-trace: Show detailed version scan activity (for debugging)
SCRIPT SCAN:
  -sC: equivalent to --script=default
  --script=<Lua scripts>: <Lua scripts> is a comma separated list of
           directories, script-files or script-categories
  --script-args=<n1=v1,[n2=v2,...]>: provide arguments to scripts
  --script-args-file=filename: provide NSE script args in a file
  --script-trace: Show all data sent and received
  --script-updatedb: Update the script database.
  --script-help=<Lua scripts>: Show help about scripts.
           <Lua scripts> is a comma-separated list of script-files or
           script-categories.
OS DETECTION:
  -O: Enable OS detection
  --osscan-limit: Limit OS detection to promising targets
  --osscan-guess: Guess OS more aggressively
TIMING AND PERFORMANCE:
  Options which take <time> are in seconds, or append 'ms' (milliseconds),
  's' (seconds), 'm' (minutes), or 'h' (hours) to the value (e.g. 30m).
  -T<0-5>: Set timing template (higher is faster)
  --min-hostgroup/max-hostgroup <size>: Parallel host scan group sizes
  --min-parallelism/max-parallelism <numprobes>: Probe parallelization
  --min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout <time>: Specifies
      probe round trip time.
  --max-retries <tries>: Caps number of port scan probe retransmissions.
  --host-timeout <time>: Give up on target after this long
  --scan-delay/--max-scan-delay <time>: Adjust delay between probes
  --min-rate <number>: Send packets no slower than <number> per second
  --max-rate <number>: Send packets no faster than <number> per second
FIREWALL/IDS EVASION AND SPOOFING:
  -f; --mtu <val>: fragment packets (optionally w/given MTU)
  -D <decoy1,decoy2[,ME],...>: Cloak a scan with decoys
  -S <IP_Address>: Spoof source address
  -e <iface>: Use specified interface
  -g/--source-port <portnum>: Use given port number
  --proxies <url1,[url2],...>: Relay connections through HTTP/SOCKS4 proxies
  --data <hex string>: Append a custom payload to sent packets
  --data-string <string>: Append a custom ASCII string to sent packets
  --data-length <num>: Append random data to sent packets
  --ip-options <options>: Send packets with specified ip options
  --ttl <val>: Set IP time-to-live field
  --spoof-mac <mac address/prefix/vendor name>: Spoof your MAC address
  --badsum: Send packets with a bogus TCP/UDP/SCTP checksum
OUTPUT:
  -oN/-oX/-oS/-oG <file>: Output scan in normal, XML, s|<rIpt kIddi3,
     and Grepable format, respectively, to the given filename.
  -oA <basename>: Output in the three major formats at once
  -v: Increase verbosity level (use -vv or more for greater effect)
  -d: Increase debugging level (use -dd or more for greater effect)
  --reason: Display the reason a port is in a particular state
  --open: Only show open (or possibly open) ports
  --packet-trace: Show all packets sent and received
  --iflist: Print host interfaces and routes (for debugging)
  --append-output: Append to rather than clobber specified output files
  --resume <filename>: Resume an aborted scan
  --stylesheet <path/URL>: XSL stylesheet to transform XML output to HTML
  --webxml: Reference stylesheet from Nmap.Org for more portable XML
  --no-stylesheet: Prevent associating of XSL stylesheet w/XML output
MISC:
  -6: Enable IPv6 scanning
  -A: Enable OS detection, version detection, script scanning, and traceroute
  --datadir <dirname>: Specify custom Nmap data file location
  --send-eth/--send-ip: Send using raw ethernet frames or IP packets
  --privileged: Assume that the user is fully privileged
  --unprivileged: Assume the user lacks raw socket privileges
  -V: Print version number
  -h: Print this help summary page.
EXAMPLES:
  nmap -v -A scanme.nmap.org
  nmap -v -sn 192.168.0.0/16 10.0.0.0/8
  nmap -v -iR 10000 -Pn -p 80
SEE THE MAN PAGE (https://nmap.org/book/man.html) FOR MORE OPTIONS AND EXAMPLES

```



